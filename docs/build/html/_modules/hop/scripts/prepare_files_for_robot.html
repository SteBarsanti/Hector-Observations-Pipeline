<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hop.scripts.prepare_files_for_robot &#8212; Hector Observations Pipeline 1.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          Hector Observations Pipeline</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../calculating_offsets.html">Calculating Offsets from one Hexabundle to another</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plot_plate_configuration.html">Plotting a plate configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../show_sky_fibre_changes_between_plates.html">Showing the Sky Fibre Changes between Plates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../check_magnet_counts_between_tiles.html">Checking two plates can be observed after each other</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../prepare_files_for_robot.html">Preparing files to be configured by the robot</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for hop.scripts.prepare_files_for_robot</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># disabled warning about writes making it back to the original frame</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">atan</span><span class="p">,</span><span class="n">sin</span><span class="p">,</span><span class="n">cos</span><span class="p">,</span><span class="n">sqrt</span><span class="p">,</span><span class="n">degrees</span><span class="p">,</span><span class="n">radians</span><span class="p">,</span><span class="n">pi</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">hop.scripts</span> <span class="kn">import</span> <span class="n">robot_corrections</span> <span class="k">as</span> <span class="n">corrections</span>
<span class="kn">from</span> <span class="nn">hop.scripts</span> <span class="kn">import</span> <span class="n">robot_file_input_output</span> <span class="k">as</span> <span class="n">file_functions</span>

<div class="viewcode-block" id="correct_parking_positions_file"><a class="viewcode-back" href="../../../hop.scripts.html#hop.scripts.prepare_files_for_robot.correct_parking_positions_file">[docs]</a><span class="k">def</span> <span class="nf">correct_parking_positions_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">robot_shifts_file</span><span class="p">,</span> <span class="n">T_observed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">T_configured</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plate_radius</span><span class="o">=</span><span class="mf">226.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.2e-6</span><span class="p">,</span> <span class="n">robot_centre</span><span class="o">=</span><span class="p">[</span><span class="mf">324.470</span><span class="p">,</span><span class="mf">297.834</span><span class="p">],</span> <span class="n">apply_metrology_calibration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apply_roll_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply the necessary corrections to the x and y *parking positions* of the Hector magnets. We then write this file out to a new one with the exact same format</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Adjusting the Parking Positions:&#39;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">file_functions</span><span class="o">.</span><span class="n">read_parking_positions_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">apply_corrections</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">T_observed</span><span class="o">=</span><span class="n">T_observed</span><span class="p">,</span> <span class="n">T_configured</span><span class="o">=</span><span class="n">T_configured</span><span class="p">,</span> <span class="n">plate_radius</span><span class="o">=</span><span class="n">plate_radius</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">robot_centre</span><span class="o">=</span><span class="n">robot_centre</span><span class="p">,</span> <span class="n">robot_shifts_file</span><span class="o">=</span><span class="n">robot_shifts_file</span><span class="p">,</span> <span class="n">apply_telecentricity_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_metrology_calibration</span><span class="o">=</span><span class="n">apply_metrology_calibration</span><span class="p">,</span> <span class="n">apply_roll_correction</span><span class="o">=</span><span class="n">apply_roll_correction</span><span class="p">,</span> <span class="n">apply_rotation_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># Now write the parking positions file out in the correct format</span>
    <span class="c1"># We want to keep the same long string of numbers from the filename of the Robot Shifts file</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">metrology_date</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">robot_shifts_file</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="n">fname</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">metrology_date</span><span class="si">}</span><span class="s1">.csv&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">file_functions</span><span class="o">.</span><span class="n">write_standard_parking_positions_file</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Output file: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="correct_robot_file"><a class="viewcode-back" href="../../../hop.scripts.html#hop.scripts.prepare_files_for_robot.correct_robot_file">[docs]</a><span class="k">def</span> <span class="nf">correct_robot_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">T_observed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">T_configured</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plate_radius</span><span class="o">=</span><span class="mf">226.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.2e-6</span><span class="p">,</span> <span class="n">robot_centre</span><span class="o">=</span><span class="p">[</span><span class="mf">324.470</span><span class="p">,</span><span class="mf">297.834</span><span class="p">],</span> <span class="n">robot_shifts_file</span><span class="o">=</span><span class="s1">&#39;./robot_shifts_abs.csv&#39;</span><span class="p">,</span> <span class="n">apply_telecentricity_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apply_metrology_calibration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apply_roll_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apply_rotation_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply the necessary corrections to the x and y positions of magnets in a *Hector Robot file*. We also read in and update its header</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Adjusting the Robot File&#39;</span><span class="p">)</span>
    <span class="c1"># Read in the file and save the header</span>
    <span class="c1"># getting count of lines to skip at top of file, which contain other information</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">lines</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">),</span> <span class="s2">&quot;The 7th line of this file doesn&#39;t start with #- have the headers changed? If so, update these lines of code!&quot;</span>

    <span class="c1"># Updating the header of the robot file with the updated parameters (if any)</span>
    <span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Radial_Offset_Adjustment, </span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2"> #Radial offset is in millimetre(mm) with +ve values actioning radial outward movement and -ve values actioning radial inward movement of the magnets.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">header</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Radial_Scale_factor, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">offset</span><span class="o">/</span><span class="n">plate_radius</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2"> #Radial scale factor is thermal coefficient of invar times temperature difference applied radially relative to the plate centre.</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">T_observed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">T_configured</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">header</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;RobotTemp, </span><span class="si">{</span><span class="n">T_configured</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> #temperature (degrees C) the distortion code assumed the field would be observed at</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">header</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ObsTemp, </span><span class="si">{</span><span class="n">T_observed</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> #actual temperature (degrees C) it is going to be observed at</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># Read in the file again as a data frame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">file_functions</span><span class="o">.</span><span class="n">read_standard_robot_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Now apply the corrections</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">apply_corrections</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">T_observed</span><span class="o">=</span><span class="n">T_observed</span><span class="p">,</span> <span class="n">T_configured</span><span class="o">=</span><span class="n">T_configured</span><span class="p">,</span> <span class="n">plate_radius</span><span class="o">=</span><span class="n">plate_radius</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">robot_centre</span><span class="o">=</span><span class="n">robot_centre</span><span class="p">,</span> <span class="n">robot_shifts_file</span><span class="o">=</span><span class="n">robot_shifts_file</span><span class="p">,</span> <span class="n">apply_telecentricity_correction</span><span class="o">=</span><span class="n">apply_telecentricity_correction</span><span class="p">,</span> <span class="n">apply_metrology_calibration</span><span class="o">=</span><span class="n">apply_metrology_calibration</span><span class="p">,</span> <span class="n">apply_roll_correction</span><span class="o">=</span><span class="n">apply_roll_correction</span><span class="p">,</span> <span class="n">apply_rotation_correction</span><span class="o">=</span><span class="n">apply_rotation_correction</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="n">df</span><span class="p">,</span> <span class="n">output_file</span> <span class="o">=</span> <span class="n">file_functions</span><span class="o">.</span><span class="n">write_standard_robot_file</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Output file: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="apply_corrections"><a class="viewcode-back" href="../../../hop.scripts.html#hop.scripts.prepare_files_for_robot.apply_corrections">[docs]</a><span class="k">def</span> <span class="nf">apply_corrections</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">robot_shifts_file</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">T_observed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">T_configured</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plate_radius</span><span class="o">=</span><span class="mf">226.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.2e-6</span><span class="p">,</span> <span class="n">robot_centre</span><span class="o">=</span><span class="p">[</span><span class="mf">324.470</span><span class="p">,</span><span class="mf">297.834</span><span class="p">],</span> <span class="n">apply_telecentricity_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apply_metrology_calibration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apply_roll_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apply_rotation_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">permagnet_theta_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a number of corrections to the magnet positions. The corrections are:</span>

<span class="sd">    * A radial shift inwards or outwards applied to all circular magnets to account for a difference in temperature between the plate at the time it was configured and the plate at the time it will be observed. Note that this offset can be entered in millimetres, or otherwise two temnperatures and a coefficient of thermal expansion can be given instead.</span>
<span class="sd">    * A correction on the position of each circular magnet based on its radial position in one of four telecentricity annuli. The circular magnet is moved inwards to account for the fact the light is not truly plane-parallel across the plate. </span>
<span class="sd">    * A correction on the position of all magnets based on accurate calibration of the position and rotation of the plate using the pre-defined metrology markers. This correction can be decomposed into a shift of the plate centre, a shear term and a rotation. The derived correction is fit to the measurements in the robot_shifts_file.</span>
<span class="sd">    * A correction on North/South position of all magnets based on the roll of the robot arm as it places each object. The extension of the robot arm to the far corner of the plate induces a small torque which affects its ability to place a magnet accurately. This torque has been measured and fitted with quadratic function which depends on the y value (in robot coordinates) of the magnet and is applied to its x value.</span>

<span class="sd">    For corrections which are applied to only the circular magnets, we then calculate the position of the rectangular magnets again to ensure that the distance between them is always 27.2mm. </span>

<span class="sd">    Args:</span>
<span class="sd">        filename (str):</span>
<span class="sd">            A Hector Robot file containing information about 27 circular and 27 rectnagular magnets to be placed on the plate.</span>
<span class="sd">        offset (float, optional):</span>
<span class="sd">            A radial offset (in mm) to be applied to all circular magnets. Negative values are towards the plate centre, positive values are away from the plate centre. The default is 0.0</span>
<span class="sd">        T_observed (float, optional): </span>
<span class="sd">            The temperature (in Celsius or Kelvin) at which the plate will be observed at. Default is None. </span>
<span class="sd">        T_configured (float, optional): </span>
<span class="sd">            The temperature (in Celsius or Kelvin) at which the plate was configured at. Default is None.</span>
<span class="sd">        plate_radius (float, optional):</span>
<span class="sd">            The radius of the plate in mm, for claculating the thermal expansion. Default is 226.0</span>
<span class="sd">        alpha (float, optional):</span>
<span class="sd">            The coefficient of thermal expansion of invar. Default is 1.2e-6</span>
<span class="sd">        robot_centre (list, optional): </span>
<span class="sd">            A two element list comntaing the x and y coordinates of the plate centre in the coordinates of the robot. You really shouldn&#39;t change this unless you have a very good reason! Default is [324.470,297.834]</span>
<span class="sd">        robot_shifts_file, (str, optional):</span>
<span class="sd">            The location of the metrology measurements file. Default is &#39;robot_shifts_abs.csv&#39;</span>
<span class="sd">        apply_telecentricity_correction (bool, optional):</span>
<span class="sd">            Whether or not to apply the telecentricity correction to the magnets. In all reasonable circumstances this should be True! Default is True. </span>
<span class="sd">        apply_metrology_calibration (bool, True):</span>
<span class="sd">            Whether or not to apply the metrology-based calibration correction. Should always be True. Default is True</span>
<span class="sd">        apply_roll_correction (bool, True):</span>
<span class="sd">            Whether or not to apply the robot roll correction. Should always be True. Default is True.</span>
<span class="sd">        apply_rotation_correction (bool, True):</span>
<span class="sd">            Whether or not to apply the correction for the different alignments of the robot cylinder and pickup arm. Should always be True, default is True. </span>
<span class="sd">        verbose (bool, True):</span>
<span class="sd">            Print information about the corrections to the screen. Default is True. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Some basic argument checking</span>
    <span class="k">if</span> <span class="n">T_observed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">T_configured</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;T_configured cannot be None if T_obsered is not None!&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">T_observed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">T_configured</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;T_observed cannot be None if T_configured is not None!&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">T_observed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">T_configured</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If T_configured and T_observed are given then offset can&#39;t be given as well!&quot;</span><span class="p">)</span>
        <span class="n">delta_T</span> <span class="o">=</span> <span class="n">T_configured</span> <span class="o">-</span> <span class="n">T_observed</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">plate_radius</span> <span class="o">*</span> <span class="p">(</span> <span class="n">delta_T</span> <span class="o">*</span> <span class="n">alpha</span> <span class="p">)</span>  

    
    <span class="c1"># Apply the radial offsets</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">apply_telecentricity_correction</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">corrections</span><span class="o">.</span><span class="n">apply_offsets_to_magnets</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">robot_centre</span><span class="p">,</span> <span class="n">apply_telecentricity_correction</span><span class="o">=</span><span class="n">apply_telecentricity_correction</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># Perform metrology-based calibration</span>
    <span class="k">if</span> <span class="n">apply_metrology_calibration</span><span class="p">:</span>
        <span class="n">orig_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Center_x&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Center_y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">theta_d</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rot_platePlacing&#39;</span><span class="p">]</span>
        <span class="n">metr_calibrated_coords</span><span class="p">,</span> <span class="n">calibd_theta_d</span> <span class="o">=</span> <span class="n">corrections</span><span class="o">.</span><span class="n">perform_metrology_calibration</span><span class="p">(</span><span class="n">orig_coords</span><span class="p">,</span> <span class="n">theta_d</span><span class="p">,</span>
                                                           <span class="n">robot_centre</span><span class="o">=</span><span class="n">robot_centre</span><span class="p">,</span> <span class="n">robot_shifts_file</span><span class="o">=</span><span class="n">robot_shifts_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">permagnet_theta_corr</span><span class="o">=</span><span class="n">permagnet_theta_correction</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Center_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metr_calibrated_coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Center_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metr_calibrated_coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rot_platePlacing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibd_theta_d</span>

    <span class="c1"># Apply the roll correction to the x values of the magnets _after_ the metrology correction</span>
    <span class="k">if</span> <span class="n">apply_roll_correction</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Applying the Roll Correction&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">roll_correction_offset</span> <span class="o">=</span> <span class="n">corrections</span><span class="o">.</span><span class="n">roll_correction</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Center_x&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Center_y&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Magnet&#39;</span><span class="p">])</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Center_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Center_x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">roll_correction_offset</span>

    <span class="c1">#Apply the correction for the unaligned centres of rotation for the pickup arm vs the cylinder</span>
    <span class="k">if</span> <span class="n">apply_rotation_correction</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Applying the offset-rotation-axis correction&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span> <span class="o">=</span> <span class="n">corrections</span><span class="o">.</span><span class="n">pick_up_arm_rotation_correction</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Center_x&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Center_y&#39;</span><span class="p">],</span> <span class="n">rot_platePlacing</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;rot_platePlacing&#39;</span><span class="p">])</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Center_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_x</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Center_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_y</span>

    <span class="k">return</span> <span class="n">df</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">argparse</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;robot_filename&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The full path of the robot file to apply corrections to&#39;</span><span class="p">)</span>
    <span class="c1">#parser.add_argument(&quot;parking_positions_filename&quot;, type=str, help=&#39;The full path of the parking positions file to apply corrections to&#39;)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;robot_shifts_file&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Filename of the robot metrology measurements&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--offset&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Radial offset to apply in mm. +ve is outward, -ve is inwards&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--T_observed&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Temperature at which the plate will be observed&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--T_configured&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Temperature at which the plate is configured&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--silent&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Turn off output from the code&quot;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">robot_filename</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">robot_filename</span>
    <span class="c1">#parking_positions_filename = args.parking_positions_filename</span>
    <span class="n">robot_shifts_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">robot_shifts_file</span>

    <span class="c1">#Optional Arguments</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">offset</span>
    <span class="n">T_observed</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">T_observed</span>
    <span class="n">T_configured</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">T_configured</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">silent</span>

    <span class="c1">#parking_positions_filename = &quot;/Users/samvaughan/Science/Hector/HectorObservationPipeline/tests/data/robot_corrections_files/ParkingPosns_211116-z25.7_final.csv&quot;</span>
    <span class="n">parking_positions_filename</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Z:\Robot_tile_files\ParkingPosns_final.csv&quot;</span>

    <span class="n">robot_df</span> <span class="o">=</span> <span class="n">correct_robot_file</span><span class="p">(</span><span class="n">robot_filename</span><span class="p">,</span> <span class="n">robot_shifts_file</span><span class="o">=</span><span class="n">robot_shifts_file</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">T_observed</span><span class="o">=</span><span class="n">T_observed</span><span class="p">,</span> <span class="n">T_configured</span><span class="o">=</span><span class="n">T_configured</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">parking_positions_df</span> <span class="o">=</span> <span class="n">correct_parking_positions_file</span><span class="p">(</span><span class="n">parking_positions_filename</span><span class="p">,</span> <span class="n">robot_shifts_file</span><span class="o">=</span><span class="n">robot_shifts_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">apply_metrology_calibration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apply_roll_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2022, Sam Vaughan.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.0.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>